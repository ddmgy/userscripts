// ==UserScript==
// @name        danbooru-show-profile-changes
// @version     0.2.1
// @description Show changes to your Danbooru profile page
// @author      ddmgy
// @namespace   ddmgy
// @match       *://*.donmai.us/profile
// @match       *://*.donmai.us/users/*
// @grant       GM_addStyle
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_deleteValue
// @grant       GM_listValues
// @downloadURL https://github.com/ddmgy/userscripts/blob/master/danbooru-show-profile-changes/dist/danbooru-show-profile-changes.min.user.js?raw=true
// @updateURL   https://github.com/ddmgy/userscripts/blob/master/danbooru-show-profile-changes/dist/danbooru-show-profile-changes.min.user.js?raw=true
// ==/UserScript==

"use strict";(()=>{var b=`
.dspc-positive {
  color: var(--green-4);
}
.dspc-neutral {
  color: var(--grey-4);
  display: none;
}
.dspc-negative {
  color: var(--red-4);
}
#dspc-clear-button {
  font-size: 14px;
}
`;var s=$("body").attr("data-current-user-id"),r=$("body").attr("data-current-user-name");function f(e){return`dspc-${e}`}var n=class e{static get(t,a){return GM_getValue(f(t),a)}static set(t,a){GM_setValue(f(t),a)}static keys(){return GM_listValues()}static clear(){for(let t of e.keys())GM_deleteValue(t)}static remove(t){GM_deleteValue(f(t))}};function S(e,t){return`
    <sup class="dspc-${e===0?"neutral":e>0?"positive":"negative"}" title="${t===void 0?"":t}">
      ${e}
    </sup>
  `}var P=[{name:"upload_limit_pending",endpoint:"post",selector:"tr.user-upload-limit a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("tags",`user:${r}+status:pending`)}},{name:"uploads",endpoint:"post",selector:"tr.user-uploads a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("tags",`user:${r}`)}},{name:"deleted_uploads",endpoint:"post",selector:"tr.user-deleted-uploads a",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`user:${r}+status:deleted`)}},{name:"favorites",endpoint:"post",selector:"tr.user-favorites a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`ordfav:${r}`)}},{name:"post_votes",endpoint:"post_votes",selector:"tr.user-votes a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`)}},{name:"comment_votes",endpoint:"comment_votes",selector:"tr.user-votes a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`)}},{name:"forum_post_votes",endpoint:"forum_post_votes",selector:"tr.user-votes a:nth-of-type(3)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"favorite_groups",endpoint:"favorite_groups",selector:"tr.user-favorite-groups a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"post_versions",endpoint:"post_versions",selector:"tr.user-post-changes a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"note_versions",endpoint:"note_versions",selector:"tr.user-note-changes a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"note_versions_posts",endpoint:"posts",selector:"tr.user-note-changes a:nth-of-type(2)",timeKey:"last_noted_at",addSearchParams:e=>{e.set("tags",`noteupdated:${r}+order:note`)}},{name:"wiki_page_versions",endpoint:"wiki_page_versions",selector:"tr.user-wiki-page-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"artist_versions",endpoint:"artist_versions",selector:"tr.user-artist-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"artist_commentary_versions",endpoint:"artist_commentary_versions",selector:"tr.user-commentary-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"pool_versions",endpoint:"pool_versions",selector:"tr.user-pool-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"forum_posts",endpoint:"forum_posts",selector:"tr.user-forum-posts a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"approvals",endpoint:"posts",selector:"tr.user-approvals a",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`approver:${r}`)}},{name:"comments_total",endpoint:"comments",selector:"tr.user-comments a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("group_by","comment"),e.set("search[creator_id]",`${s}`)}},{name:"comments_posts",endpoint:"posts",selector:"tr.user-comments a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`commenter:${r}+order:comment_bumped`)}},{name:"post_appeals",endpoint:"post_appeals",selector:"tr.user-appeals a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"post_flags",endpoint:"post_flags",selector:"tr.user-flags a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"feedback_positive",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`),e.set("search[category]","positive")}},{name:"feedback_neutral",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(3)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`),e.set("search[category]","neutral")}},{name:"feedback_negative",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(4)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`),e.set("search[category]","negative")}}];function k(e){let t=new URL(`https://danbooru.donmai.us/${e}.json`);return t.searchParams.set("limit","20"),t.searchParams.set("page","1"),t}function x(){let e=[{index:1,className:"user-id"},{index:2,className:"user-join-date"},{index:4,className:"user-level"},{index:5,className:"user-upload-limit"},{index:6,className:"user-uploads"},{index:7,className:"user-deleted-uploads"},{index:8,className:"user-favorites"},{index:9,className:"user-votes"},{index:10,className:"user-favorite-groups"},{index:11,className:"user-post-changes"},{index:12,className:"user-note-changes"},{index:13,className:"user-wiki-page-changes"},{index:14,className:"user-artist-changes"},{index:15,className:"user-commentary-changes"},{index:16,className:"user-pool-changes"},{index:17,className:"user-forum-posts"},{index:18,className:"user-approvals"},{index:19,className:"user-comments"},{index:20,className:"user-appeals"},{index:21,className:"user-flags"},{index:22,className:"user-feedback"},{index:23,className:"user-api-key"}];for(let{index:t,className:a}of e)$(`tr:nth-of-type(${t})`).addClass(a)}function K(){$("a.user").after(`
    <div class="dspc-clear-data">
      <button id="dspc-clear-button" title="Reset danbooru-show-profile-changes stored data">\u27F3</button>
    </div>
  `),$("#dspc-clear-button").on("click",()=>{console.log("[danbooru-show-profile-changes] clearing stored values"),n.clear()})}function N(){let e=$("tr.user-feedback a").clone(),t=$("<div></div>"),a=/positive:(\d+)\s+neutral:(\d+)\s+negative:(\d+)/.exec(e.text());a!==null&&(t.append(e.text("all ")),t.append(`<a href="${e.attr("href")}&search[category]=positive">positive:${+a[1]} </a>`),t.append(`<a href="${e.attr("href")}&search[category]=neutral">neutral:${+a[2]} </a>`),t.append(`<a href="${e.attr("href")}&search[category]=negative">negative:${+a[3]} </a>`),$("tr.user-feedback a").replaceWith(t))}async function w(e,t,a){let o=n.get(a.name);if(!t&&o!==void 0)return console.log(`[danbooru-show-profile-changes] value for key "${a.name}" already exists: ${o}`),{info:a,value:o};let d=k(a.endpoint);a.addSearchParams(d.searchParams),d.searchParams.set("only",a.timeKey);var c=0,l=1;e:for(;;){let i=await fetch(d);if(!i.ok)break;let u=await i.json();if(u.length===0)break;for(let p of u){if(Date.parse(p[a.timeKey].substring(0,16))<e)break e;c+=1}if(u.length!=20)break;l+=1,d.searchParams.set("page",`${l}`)}return console.log(`[danbooru-show-profile-changes] "${a.name}": ${c}`),{info:a,value:c}}function M(){if(s===void 0||r===void 0||r!==$("a.user").text())return;console.log("[danbooru-show-profile-changes] init"),GM_addStyle(b),x(),K(),N();let e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0);let t=e.getTime(),a=e.getFullYear().toString().padStart(4,"0"),o=(e.getMonth()+1).toString().padStart(2,"0"),d=e.getDate().toString().padStart(2,"0"),c=`${a}-${o}-${d}`,i=n.get("date_key")!==c;n.set("date_key",c);let u=P.map(p=>w(t,i,p));Promise.all(u).then(p=>{for(let m of p){let h=$(m.info.selector);if(h.length===0)continue;let g=/(\d+)/.exec(h.text());if(g===null)continue;let y=n.get(m.info.name),v=+g[1],_=y===void 0||i?v-m.value:y;$(h).after(S(v-_,`${_}`)),n.set(m.info.name,_)}})}$(M);})();
