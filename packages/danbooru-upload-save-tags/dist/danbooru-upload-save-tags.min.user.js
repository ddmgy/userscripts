// ==UserScript==
// @name        danbooru-upload-save-tags (minified)
// @version     0.1.1
// @description Add ability to save/load tags on uploads page
// @author      ddmgy
// @namespace   ddmgy
// @match       *://*.donmai.us/uploads/*
// @match       *://*.donmai.us/posts/*
// @grant       none
// @run-at      document-body
// @downloadURL https://github.com/ddmgy/userscripts/blob/master/packages/danbooru-upload-save-tags/dist/danbooru-upload-save-tags.min.user.js?raw=true
// @updateURL   https://github.com/ddmgy/userscripts/blob/master/packages/danbooru-upload-save-tags/dist/danbooru-upload-save-tags.min.user.js?raw=true
// ==/UserScript==

"use strict";(()=>{var w="danbooru_upload_save_tags";var c="uploads";function u(o){console.log(`[danbooru-upload-save-tags] ${o}`)}function d(o){console.error(`[danbooru-upload-save-tags] ${o}`)}var _=class o{db;constructor(t){this.db=t}add(t){return new Promise((n,s)=>{let a=this.db.transaction(c,"readwrite");a.addEventListener("error",r=>{d(`Error adding item: ${r}`),n(!1)});let e=a.objectStore(c).add(t);e.addEventListener("error",r=>{d(`Error adding item: ${r}`),n(!1)}),e.addEventListener("success",r=>n(!0))})}clear(){return new Promise((t,n)=>{let s=this.db.transaction(c,"readwrite");s.addEventListener("error",e=>{d(`Error clearing database: ${e}`),t(!1)});let i=s.objectStore(c).clear();i.addEventListener("error",e=>{d(`Error clearing database: ${e}`),t(!1)}),i.addEventListener("success",e=>t(!0))})}count(){return new Promise((t,n)=>{let s=this.db.transaction(c,"readonly");s.addEventListener("error",e=>{d(`Error counting items: ${e}`),t(-1)});let i=s.objectStore(c).count();i.addEventListener("error",e=>{d(`Error counting items: ${e}`),t(-1)}),i.addEventListener("success",e=>t(i.result))})}delete(t){return new Promise((n,s)=>{let a=this.db.transaction(c,"readwrite");a.addEventListener("error",r=>{d(`Error deleting item: ${r}`),n(!1)});let e=a.objectStore(c).delete(t);e.addEventListener("error",r=>{d(`Error deleting item: ${r}`),n(!1)}),e.addEventListener("success",r=>n(!0))})}deleteOld(t){return new Promise(async(n,s)=>{let a=t-432e6,i=await this.getAll();for(let e of i){if(e.timestamp>a)continue;u(`deleting entry: ${e.mediaAssetId}`);let r=await this.delete(e.mediaAssetId);u(`  success?: ${r}`)}n(!0)})}get(t){return new Promise((n,s)=>{let a=this.db.transaction(c,"readonly");a.addEventListener("error",r=>{d(`Error getting item: ${r}`),s(new Error(`Error getting item: ${r}`))});let e=a.objectStore(c).get(t);e.addEventListener("error",r=>{d(`Error getting item: ${r}`),s(new Error(`Error getting item: ${r}`))}),e.addEventListener("success",function(r){n(this.result)})})}getAll(){return new Promise((t,n)=>{let s=this.db.transaction(c,"readonly");s.addEventListener("error",e=>{d(`Error getting items: ${e}`),n(new Error(`Error getting items: ${e}`))});let i=s.objectStore(c).getAll();i.addEventListener("error",e=>{d(`Error getting items: ${e}`),n(new Error(`Error getting items: ${e}`))}),i.addEventListener("success",function(e){t(this.result)})})}put(t){return new Promise((n,s)=>{let a=this.db.transaction(c,"readwrite");a.addEventListener("error",r=>{d(`Error putting item: ${r}`),n(!1)});let e=a.objectStore(c).put(t);e.addEventListener("error",r=>{d(`Error putting item: ${r}`),n(!1)}),e.addEventListener("success",r=>n(!0))})}static initialize(){return new Promise((t,n)=>{let s=window.indexedDB.open(w,2);s.addEventListener("upgradeneeded",function(a){let i=this.result;i.addEventListener("error",()=>{n(new Error("Error loading DB"))});let e=i.createObjectStore(c,{keyPath:"mediaAssetId",autoIncrement:!0});e.createIndex("mediaAssetId","mediaAssetId",{unique:!0}),e.createIndex("rating","rating",{unique:!1}),e.createIndex("tags","tags",{unique:!1}),e.createIndex("source","source",{unique:!1}),e.createIndex("originalTitle","originalTitle",{unique:!1}),e.createIndex("originalDescription","originalDescription",{unique:!1}),e.createIndex("translatedTitle","translatedTitle",{unique:!1}),e.createIndex("translatedDescription","translatedDescription",{unique:!1}),e.createIndex("parentId","parentId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}),s.addEventListener("error",()=>{n(new Error("Error opening DB"))}),s.addEventListener("success",function(){t(new o(this.result))})})}};async function L(o,t){let n=$("a[href^='/media_assets/']");if(!n.length)return;let s=/\/media_assets\/(\d+)/.exec(n.attr("href"));if(s===null)return;let a=+s[1],i=$('<button class="ui-button ui-widget ui-corner-all" type="button">Save</button>'),e=$('<button class="ui-button ui-widget ui-corner-all" type="button">Load</button>');$("div.tab-list").append(i),$("div.tab-list").append(e),i.on("click",async()=>{let r=$("span.radio input[type='radio']:checked").val(),l=$("#post_tag_string").val(),m=$("#post_source").val(),g=$("#post_artist_commentary_title").val(),p=$("#post_artist_commentary_desc").val(),E=$("#post_translated_commentary_title").val(),b=$("#post_translated_commentary_desc").val(),f=$("#post_parent_id").val(),v=new Date().getTime();await o.put({mediaAssetId:a,rating:r,tags:l,source:m,originalTitle:g,originalDescription:p,translatedTitle:E,translatedDescription:b,parentId:f,timestamp:v}),u(`Saved information for media asset ${a}`)}),e.on("click",async()=>{let r=await o.get(a);if(r===void 0)return;let{rating:l,tags:m,source:g,originalTitle:p,originalDescription:E,translatedTitle:b,translatedDescription:f,parentId:v}=r;l!==void 0&&$(`input#post_rating_${l}`).trigger("click"),$("#post_tag_string").val(m),$("#post_source").val(g),$("#post_artist_commentary_title").val(p),$("#post_artist_commentary_desc").val(E),$("#post_translated_commentary_title").val(b),$("#post_translated_commentary_desc").val(f),$("#post_parent_id").val(v),u(`Loaded information for media asset ${a}`)})}async function I(o,t){let s=(await(await fetch(`/posts/${t}.json?only=media_asset[id]`)).json()).media_asset.id;await o.delete(s),await o.deleteOld(new Date().getTime())}async function h(){_.initialize().then(o=>{var t;(t=/\/uploads\/(\d+)/.exec(window.location.pathname))?L(o,+t[1]):(t=/\/posts\/(\d+)/.exec(window.location.pathname))?I(o,+t[1]):d(`running on unknown page: ${window.location.href}`)}).catch(o=>d(`Error loading DB: ${o}`))}$(h);})();
