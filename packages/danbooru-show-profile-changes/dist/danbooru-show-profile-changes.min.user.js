// ==UserScript==
// @name        danbooru-show-profile-changes (minified)
// @version     0.3.1
// @description Show changes to your Danbooru profile page
// @author      ddmgy
// @namespace   ddmgy
// @match       *://*.donmai.us/profile
// @match       *://*.donmai.us/users/*
// @grant       GM_addStyle
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_deleteValue
// @grant       GM_listValues
// @downloadURL https://github.com/ddmgy/userscripts/blob/master/packages/danbooru-show-profile-changes/dist/danbooru-show-profile-changes.min.user.js?raw=true
// @updateURL   https://github.com/ddmgy/userscripts/blob/master/packages/danbooru-show-profile-changes/dist/danbooru-show-profile-changes.min.user.js?raw=true
// ==/UserScript==

"use strict";(()=>{var k=`
.dspc-positive {
  color: var(--green-4);
}
.dspc-neutral {
  color: var(--grey-4);
  display: none;
}
.dspc-negative {
  color: var(--red-4);
}
`;var a=$("body").attr("data-current-user-id"),r=$("body").attr("data-current-user-name");function g(e){return`dspc-${e}`}var o=class e{static get(t,s){return GM_getValue(g(t),s)}static set(t,s){GM_setValue(g(t),s)}static keys(){return GM_listValues()}static clear(){for(let t of e.keys())GM_deleteValue(t)}static remove(t){GM_deleteValue(g(t))}};function S(e,t){return`
    <sup class="dspc-${e===0?"neutral":e>0?"positive":"negative"}" title="${t===void 0?"":t}">
      ${e}
    </sup>
  `}function P(e){switch(e){case"Member":return 20;case"Gold":return 30;case"Platinum":return 31;case"Builder":return 32;case"Contributor":return 35;case"Approver":return 37;case"Moderator":return 40;case"Admin":return 50;case"Owner":return 60}return 10}var K=[{name:"upload_limit_pending",endpoint:"posts",selector:"tr.user-upload-limit a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("tags",`user:${r}+status:pending`)}},{name:"uploads",endpoint:"posts",selector:"tr.user-uploads a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("tags",`user:${r}`)}},{name:"deleted_uploads",endpoint:"posts",selector:"tr.user-deleted-uploads a",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`user:${r}+status:deleted`)}},{name:"favorites",endpoint:"posts",selector:"tr.user-favorites a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`ordfav:${r}`)}},{name:"post_votes",endpoint:"post_votes",selector:"tr.user-votes a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${a}`)}},{name:"comment_votes",endpoint:"comment_votes",selector:"tr.user-votes a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${a}`)}},{name:"forum_post_votes",endpoint:"forum_post_votes",selector:"tr.user-votes a:nth-of-type(3)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${a}`)}},{name:"favorite_groups",endpoint:"favorite_groups",selector:"tr.user-favorite-groups a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${a}`)}},{name:"post_versions",endpoint:"post_versions",selector:"tr.user-post-changes a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${a}`)}},{name:"note_versions",endpoint:"note_versions",selector:"tr.user-note-changes a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("search[updater_id]",`${a}`)}},{name:"note_versions_posts",endpoint:"posts",selector:"tr.user-note-changes a:nth-of-type(2)",timeKey:"last_noted_at",addSearchParams:e=>{e.set("tags",`noteupdated:${r}+order:note`)}},{name:"wiki_page_versions",endpoint:"wiki_page_versions",selector:"tr.user-wiki-page-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${a}`)}},{name:"artist_versions",endpoint:"artist_versions",selector:"tr.user-artist-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${a}`)}},{name:"artist_commentary_versions",endpoint:"artist_commentary_versions",selector:"tr.user-commentary-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${a}`)}},{name:"pool_versions",endpoint:"pool_versions",selector:"tr.user-pool-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${a}`)}},{name:"forum_posts",endpoint:"forum_posts",selector:"tr.user-forum-posts a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${a}`)}},{name:"approvals",endpoint:"posts",selector:"tr.user-approvals a",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`approver:${r}`)}},{name:"comments_total",endpoint:"comments",selector:"tr.user-comments a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("group_by","comment"),e.set("search[creator_id]",`${a}`)}},{name:"comments_posts",endpoint:"posts",selector:"tr.user-comments a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`commenter:${r}+order:comment_bumped`)}},{name:"post_appeals",endpoint:"post_appeals",selector:"tr.user-appeals a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${a}`)}},{name:"post_flags",endpoint:"post_flags",selector:"tr.user-flags a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${a}`)}},{name:"feedback_positive",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${a}`),e.set("search[category]","positive")}},{name:"feedback_neutral",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(3)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${a}`),e.set("search[category]","neutral")}},{name:"feedback_negative",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(4)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${a}`),e.set("search[category]","negative")}}];function N(e){let t=new URL(`https://danbooru.donmai.us/${e}.json`);return t.searchParams.set("limit","20"),t.searchParams.set("page","1"),t}function w(){let e=n=>n.replace(/:/g,"%3A"),t=[{className:"user-level",selector:'href^="/upgrade"'},{className:"user-upload-limit",selector:'href*="status:pending"'},{className:"user-uploads",selector:`href="/posts?tags=user:${r}"`},{className:"user-deleted-uploads",selector:'href*="status:deleted"'},{className:"user-favorites",selector:`href*="ordfav:${r}"`},{className:"user-votes",selector:'href^="/post_votes"'},{className:"user-favorite-groups",selector:'href^="/favorite_groups"'},{className:"user-post-changes",selector:'href^="/post_versions"'},{className:"user-note-changes",selector:'href^="/note_versions"'},{className:"user-wiki-page-changes",selector:'href^="/wiki_page_versions"'},{className:"user-artist-changes",selector:'href^="/artist_versions"'},{className:"user-commentary-changes",selector:'href^="/artist_commentary_versions"'},{className:"user-pool-changes",selector:'href^="/pool_versions"'},{className:"user-forum-posts",selector:'href^="/forum_posts"'},{className:"user-approvals",selector:`href*="tags=approver:${r}"`},{className:"user-comments",selector:'href^="/comments"'},{className:"user-appeals",selector:'href^="/post_appeals"'},{className:"user-flags",selector:'href^="/post_flags"'},{className:"user-feedback",selector:'href^="/user_feedbacks"'},{className:"user-saved-searches",selector:'href*="search:"'},{className:"user-api-key",selector:`href="/users/${a}/api_keys"`}],s=$("table.user-statistics tr");for(let{className:n,selector:c}of t){let d=s.find(`a[${e(c)}]:nth-of-type(1)`);d.length&&d.parents("tr").addClass(n)}}function M(){$("table.user-statistics").parent().after(`
    <br />
    <div class="dspc-clear-data">
      <button id="dspc-clear-button">Reset danbooru-show-profile-changes stored data</button>
    </div>
  `),$("#dspc-clear-button").on("click",()=>{Danbooru.notice("Clearing danbooru-show-profile-changes stored data"),console.log("[danbooru-show-profile-changes] clearing stored values"),o.clear()})}function T(){let e=$("tr.user-feedback a").clone(),t=$("<div></div>"),s=/positive:(\d+)\s+neutral:(\d+)\s+negative:(\d+)/.exec(e.text());s!==null&&(t.append(e.text("all ")),t.append(`<a href="${e.attr("href")}&search[category]=positive">positive:${+s[1]} </a>`),t.append(`<a href="${e.attr("href")}&search[category]=neutral">neutral:${+s[2]} </a>`),t.append(`<a href="${e.attr("href")}&search[category]=negative">negative:${+s[3]} </a>`),$("tr.user-feedback a").replaceWith(t))}async function I(e,t,s){let n=o.get(s.name);if(!t&&n!==void 0)return{info:s,value:n};let c=N(s.endpoint);s.addSearchParams(c.searchParams),c.searchParams.set("only",s.timeKey);var d=0,h=1;e:for(;;){let l=await fetch(c);if(!l.ok)break;let p=await l.json();if(p.length===0)break;for(let u of p){if(Date.parse(u[s.timeKey].substring(0,16))<e)break e;d+=1}if(p.length!=20)break;h+=1,c.searchParams.set("page",`${h}`)}return{info:s,value:d}}function G(){if(a===void 0||r===void 0||r!==$("a.user").attr("data-user-name"))return;GM_addStyle(k),w(),M(),T();let e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0);let t=e.getTime(),s=e.getFullYear().toString().padStart(4,"0"),n=(e.getMonth()+1).toString().padStart(2,"0"),c=e.getDate().toString().padStart(2,"0"),d=`${s}-${n}-${c}`,l=o.get("date_key")!==d;o.set("date_key",d);let p=K.map(i=>I(t,l,i));Promise.all(p).then(i=>{for(let m of i){let f=$(m.info.selector);if(f.length===0)continue;let v=/(\d+)/.exec(f.text());if(v===null)continue;let y=o.get(m.info.name),b=+v[1],_=y===void 0||l?b-m.value:y;$(f).after(S(b-_,`${_}`)),o.set(m.info.name,_)}});let u=$("body").attr("data-current-user-level-string");if(u!==void 0){let i=o.get("user_level");i!==void 0?$("tr.user-level td").replaceWith(`<td>${u} ${S(P(u)-P(i),i)}</td>`):$("tr.user-level td").replaceWith(`<td>${u}</td>`),o.set("user_level",u)}}$(G);})();
