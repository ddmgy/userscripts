// ==UserScript==
// @name        danbooru-show-profile-changes (minified)
// @version     0.2.2
// @description Show changes to your Danbooru profile page
// @author      ddmgy
// @namespace   ddmgy
// @match       *://*.donmai.us/profile
// @match       *://*.donmai.us/users/*
// @grant       GM_addStyle
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_deleteValue
// @grant       GM_listValues
// @downloadURL https://github.com/ddmgy/userscripts/blob/master/packages/danbooru-show-profile-changes/dist/danbooru-show-profile-changes.min.user.js?raw=true
// @updateURL   https://github.com/ddmgy/userscripts/blob/master/packages/danbooru-show-profile-changes/dist/danbooru-show-profile-changes.min.user.js?raw=true
// ==/UserScript==

"use strict";(()=>{var k=`
.dspc-positive {
  color: var(--green-4);
}
.dspc-neutral {
  color: var(--grey-4);
  display: none;
}
.dspc-negative {
  color: var(--red-4);
}
#dspc-clear-button {
  font-size: 14px;
}
`;var s=$("body").attr("data-current-user-id"),n=$("body").attr("data-current-user-name");function g(e){return`dspc-${e}`}var r=class e{static get(t,a){return GM_getValue(g(t),a)}static set(t,a){GM_setValue(g(t),a)}static keys(){return GM_listValues()}static clear(){for(let t of e.keys())GM_deleteValue(t)}static remove(t){GM_deleteValue(g(t))}};function S(e,t){return`
    <sup class="dspc-${e===0?"neutral":e>0?"positive":"negative"}" title="${t===void 0?"":t}">
      ${e}
    </sup>
  `}function P(e){switch(e){case"Member":return 20;case"Gold":return 30;case"Platinum":return 31;case"Builder":return 32;case"Contributor":return 35;case"Approver":return 37;case"Moderator":return 40;case"Admin":return 50;case"Owner":return 60}return 10}var x=[{name:"upload_limit_pending",endpoint:"post",selector:"tr.user-upload-limit a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("tags",`user:${n}+status:pending`)}},{name:"uploads",endpoint:"post",selector:"tr.user-uploads a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("tags",`user:${n}`)}},{name:"deleted_uploads",endpoint:"post",selector:"tr.user-deleted-uploads a",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`user:${n}+status:deleted`)}},{name:"favorites",endpoint:"post",selector:"tr.user-favorites a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`ordfav:${n}`)}},{name:"post_votes",endpoint:"post_votes",selector:"tr.user-votes a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`)}},{name:"comment_votes",endpoint:"comment_votes",selector:"tr.user-votes a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`)}},{name:"forum_post_votes",endpoint:"forum_post_votes",selector:"tr.user-votes a:nth-of-type(3)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"favorite_groups",endpoint:"favorite_groups",selector:"tr.user-favorite-groups a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"post_versions",endpoint:"post_versions",selector:"tr.user-post-changes a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"note_versions",endpoint:"note_versions",selector:"tr.user-note-changes a:nth-of-type(1)",timeKey:"created_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"note_versions_posts",endpoint:"posts",selector:"tr.user-note-changes a:nth-of-type(2)",timeKey:"last_noted_at",addSearchParams:e=>{e.set("tags",`noteupdated:${n}+order:note`)}},{name:"wiki_page_versions",endpoint:"wiki_page_versions",selector:"tr.user-wiki-page-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"artist_versions",endpoint:"artist_versions",selector:"tr.user-artist-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"artist_commentary_versions",endpoint:"artist_commentary_versions",selector:"tr.user-commentary-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"pool_versions",endpoint:"pool_versions",selector:"tr.user-pool-changes a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[updater_id]",`${s}`)}},{name:"forum_posts",endpoint:"forum_posts",selector:"tr.user-forum-posts a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"approvals",endpoint:"posts",selector:"tr.user-approvals a",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`approver:${n}`)}},{name:"comments_total",endpoint:"comments",selector:"tr.user-comments a:nth-of-type(1)",timeKey:"updated_at",addSearchParams:e=>{e.set("group_by","comment"),e.set("search[creator_id]",`${s}`)}},{name:"comments_posts",endpoint:"posts",selector:"tr.user-comments a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("tags",`commenter:${n}+order:comment_bumped`)}},{name:"post_appeals",endpoint:"post_appeals",selector:"tr.user-appeals a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"post_flags",endpoint:"post_flags",selector:"tr.user-flags a",timeKey:"updated_at",addSearchParams:e=>{e.set("search[creator_id]",`${s}`)}},{name:"feedback_positive",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(2)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`),e.set("search[category]","positive")}},{name:"feedback_neutral",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(3)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`),e.set("search[category]","neutral")}},{name:"feedback_negative",endpoint:"user_feedbacks",selector:"tr.user-feedback a:nth-of-type(4)",timeKey:"updated_at",addSearchParams:e=>{e.set("search[user_id]",`${s}`),e.set("search[category]","negative")}}];function K(e){let t=new URL(`https://danbooru.donmai.us/${e}.json`);return t.searchParams.set("limit","20"),t.searchParams.set("page","1"),t}function N(){let e=[{index:1,className:"user-id"},{index:2,className:"user-join-date"},{index:4,className:"user-level"},{index:5,className:"user-upload-limit"},{index:6,className:"user-uploads"},{index:7,className:"user-deleted-uploads"},{index:8,className:"user-favorites"},{index:9,className:"user-votes"},{index:10,className:"user-favorite-groups"},{index:11,className:"user-post-changes"},{index:12,className:"user-note-changes"},{index:13,className:"user-wiki-page-changes"},{index:14,className:"user-artist-changes"},{index:15,className:"user-commentary-changes"},{index:16,className:"user-pool-changes"},{index:17,className:"user-forum-posts"},{index:18,className:"user-approvals"},{index:19,className:"user-comments"},{index:20,className:"user-appeals"},{index:21,className:"user-flags"},{index:22,className:"user-feedback"},{index:23,className:"user-api-key"}];for(let{index:t,className:a}of e)$(`tr:nth-of-type(${t})`).addClass(a)}function w(){$("a.user").after(`
    <div class="dspc-clear-data">
      <button id="dspc-clear-button" title="Reset danbooru-show-profile-changes stored data">\u27F3</button>
    </div>
  `),$("#dspc-clear-button").on("click",()=>{console.log("[danbooru-show-profile-changes] clearing stored values"),r.clear()})}function M(){let e=$("tr.user-feedback a").clone(),t=$("<div></div>"),a=/positive:(\d+)\s+neutral:(\d+)\s+negative:(\d+)/.exec(e.text());a!==null&&(t.append(e.text("all ")),t.append(`<a href="${e.attr("href")}&search[category]=positive">positive:${+a[1]} </a>`),t.append(`<a href="${e.attr("href")}&search[category]=neutral">neutral:${+a[2]} </a>`),t.append(`<a href="${e.attr("href")}&search[category]=negative">negative:${+a[3]} </a>`),$("tr.user-feedback a").replaceWith(t))}async function T(e,t,a){let c=r.get(a.name);if(!t&&c!==void 0)return console.log(`[danbooru-show-profile-changes] value for key "${a.name}" already exists: ${c}`),{info:a,value:c};let i=K(a.endpoint);a.addSearchParams(i.searchParams),i.searchParams.set("only",a.timeKey);var u=0,h=1;e:for(;;){let l=await fetch(i);if(!l.ok)break;let p=await l.json();if(p.length===0)break;for(let d of p){if(Date.parse(d[a.timeKey].substring(0,16))<e)break e;u+=1}if(p.length!=20)break;h+=1,i.searchParams.set("page",`${h}`)}return console.log(`[danbooru-show-profile-changes] "${a.name}": ${u}`),{info:a,value:u}}function G(){if(s===void 0||n===void 0||n!==$("a.user").text())return;console.log("[danbooru-show-profile-changes] init"),GM_addStyle(k),N(),w(),M();let e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0);let t=e.getTime(),a=e.getFullYear().toString().padStart(4,"0"),c=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),u=`${a}-${c}-${i}`,l=r.get("date_key")!==u;r.set("date_key",u);let p=x.map(o=>T(t,l,o));Promise.all(p).then(o=>{for(let m of o){let _=$(m.info.selector);if(_.length===0)continue;let v=/(\d+)/.exec(_.text());if(v===null)continue;let y=r.get(m.info.name),b=+v[1],f=y===void 0||l?b-m.value:y;$(_).after(S(b-f,`${f}`)),r.set(m.info.name,f)}});let d=$("body").attr("data-current-user-level-string");if(d!==void 0){let o=r.get("user_level");o!==void 0?$("tr.user-level td").replaceWith(`<td>${d} ${S(P(d)-P(o),o)}</td>`):$("tr.user-level td").replaceWith(`<td>${d}</td>`),r.set("user_level",d)}}$(G);})();
